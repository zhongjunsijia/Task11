{% extends 'pollution_app/base.html' %}

{% block title %}走势图 - 监测分析 - 气象污染预测系统{% endblock %}

{% block content %}
<div class="container mt-4 mb-6">
    <div class="row">
        <!-- 左侧导航栏 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">分析工具</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'monitoring_analysis' %}?view=calendar" class="text-decoration-none {% if '/monitoring/' in request.path and 'view=calendar' in request.GET.urlencode %}active fw-bold{% endif %}">
                            污染日历
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'pollution_map' %}" class="text-decoration-none {% if '/pollution-map/' in request.path %}active fw-bold{% endif %}">
                            污染地图
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'sounding' %}" class="text-decoration-none {% if '/monitoring/sounding/' in request.path %}active fw-bold{% endif %}">
                            探空图
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'trend_chart' %}" class="text-decoration-none active fw-bold">
                            走势图
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'windrose' %}" class="text-decoration-none {% if '/windrose/' in request.path %}active fw-bold{% endif %}">
                            风玫瑰图
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 右侧走势图内容区域 -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-3">
                    <h5 class="mb-0">气象污染走势图分析</h5>
                    <div class="d-flex flex-wrap gap-3">
                        <!-- 图表类型选择器 -->
                        <div class="d-flex align-items-center">
                            <label for="chart-type" class="me-2 mb-0">图表类型:</label>
                            <select id="chart-type" class="form-select form-select-sm">
                                <option value="pollutant">单一污染物走势</option>
                                <option value="meteorology">气象因素关联</option>
                            </select>
                        </div>

                        <!-- 污染物选择器 -->
                        <div class="d-flex align-items-center" id="pollutant-selector">
                            <label for="pollutant" class="me-2 mb-0">污染物:</label>
                            <select id="pollutant" class="form-select form-select-sm">
                                <option value="pm25" selected>PM2.5</option>
                                <option value="pm10">PM10</option>
                                <option value="no2">二氧化氮</option>
                                <option value="so2">二氧化硫</option>
                                <option value="o3">臭氧</option>
                                <option value="co">一氧化碳</option>
                            </select>
                        </div>

                        <!-- 气象因素选择器 (默认隐藏) -->
                        <div class="d-flex align-items-center" id="meteorology-selector" style="display: none;">
                            <label for="meteorology-factor" class="me-2 mb-0">气象因素:</label>
                            <select id="meteorology-factor" class="form-select form-select-sm">
                                <option value="temperature" selected>温度 (℃)</option>
                                <option value="humidity">湿度 (%)</option>
                                <option value="wind_speed">风速 (m/s)</option>
                                <option value="pressure">气压 (hPa)</option>
                                <option value="precipitation">降水量 (mm)</option>
                            </select>
                        </div>

                        <!-- 时间范围选择器 -->
                        <div class="d-flex align-items-center">
                            <label for="time-range" class="me-2 mb-0">时间范围:</label>
                            <select id="time-range" class="form-select form-select-sm">
                                <option value="3d">近3天</option>
                                <option value="7d">近7天</option>
                                <option value="30d" selected>近30天</option>
                                <option value="90d">近90天</option>
                                <option value="180d">近半年</option>
                                <option value="365d">近一年</option>
                            </select>
                        </div>

                        <!-- 标注控制和视图切换按钮 -->
                        <div class="d-flex align-items-center">
                            <button id="toggle-annotations" class="btn btn-sm btn-outline-secondary me-1">
                                <i class="fa fa-flag"></i> 显示标注
                            </button>
                            <button id="chart-view" class="btn btn-sm btn-primary">图表视图</button>
                            <button id="table-view" class="btn btn-sm btn-outline-secondary ms-1">表格视图</button>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- 加载状态 -->
                    <div id="chartLoader" class="text-center py-5 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载走势数据...</p>
                    </div>

                    <!-- 图表容器 -->
                    <div id="chartContainer" style="height: 500px;">
                        <canvas id="trendChart"></canvas>
                    </div>

                    <!-- 表格容器 (默认隐藏) -->
                    <div id="tableContainer" class="table-responsive mt-4" style="display: none;">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>日期时间</th>
                                    <th>PM2.5 (μg/m³)</th>
                                    <th>PM10 (μg/m³)</th>
                                    <th>二氧化氮 (μg/m³)</th>
                                    <th>二氧化硫 (μg/m³)</th>
                                    <th>臭氧 (μg/m³)</th>
                                    <th>一氧化碳 (mg/m³)</th>
                                    <th>温度 (℃)</th>
                                    <th>湿度 (%)</th>
                                    <th>风速 (m/s)</th>
                                    <th>污染等级</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <!-- 表格数据将通过JS动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
<script>
// 页面加载完成后初始化图表
document.addEventListener('DOMContentLoaded', function() {
    // 添加Font Awesome支持
    const style = document.createElement('link');
    style.href = 'https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css';
    style.rel = 'stylesheet';
    document.head.appendChild(style);

    initTrendChart();
    setupEventListeners();
});

// 初始化走势图
let trendChart = null;
let showAnnotations = true; // 控制是否显示标注

function initTrendChart() {
    const ctx = document.getElementById('trendChart').getContext('2d');
    const chartType = document.getElementById('chart-type').value;
    const pollutant = document.getElementById('pollutant').value;
    const meteorologyFactor = document.getElementById('meteorology-factor').value;
    const timeRange = document.getElementById('time-range').value;
    const days = parseInt(timeRange);

    // 生成日期标签
    const dates = Array.from({length: days}, (_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - (days - i - 1));
        return `${d.getMonth() + 1}/${d.getDate()}`;
    });

    // 销毁旧图表
    if (trendChart) {
        trendChart.destroy();
    }

    // 污染物配置映射
    const pollutantConfig = {
        pm25: { label: 'PM2.5', color: 'rgba(255, 99, 132, 1)', bgColor: 'rgba(255, 99, 132, 0.1)', unit: 'μg/m³' },
        pm10: { label: 'PM10', color: 'rgba(54, 162, 235, 1)', bgColor: 'rgba(54, 162, 235, 0.1)', unit: 'μg/m³' },
        no2: { label: '二氧化氮', color: 'rgba(255, 206, 86, 1)', bgColor: 'rgba(255, 206, 86, 0.1)', unit: 'μg/m³' },
        so2: { label: '二氧化硫', color: 'rgba(75, 192, 192, 1)', bgColor: 'rgba(75, 192, 192, 0.1)', unit: 'μg/m³' },
        o3: { label: '臭氧', color: 'rgba(153, 102, 255, 1)', bgColor: 'rgba(153, 102, 255, 0.1)', unit: 'μg/m³' },
        co: { label: '一氧化碳', color: 'rgba(255, 159, 64, 1)', bgColor: 'rgba(255, 159, 64, 0.1)', unit: 'mg/m³' }
    };

    // 气象因素配置映射
    const meteorologyConfig = {
        temperature: { label: '温度', color: 'rgba(255, 99, 71, 1)', unit: '℃' },
        humidity: { label: '湿度', color: 'rgba(30, 144, 255, 1)', unit: '%' },
        wind_speed: { label: '风速', color: 'rgba(60, 179, 113, 1)', unit: 'm/s' },
        pressure: { label: '气压', color: 'rgba(178, 34, 34, 1)', unit: 'hPa' },
        precipitation: { label: '降水量', color: 'rgba(70, 130, 180, 1)', unit: 'mm' }
    };

    // 生成模拟数据
    const datasets = [];
    let primaryDatasetIndex = 0;
    let primaryData = [];

    if (chartType === 'pollutant') {
        // 单一污染物走势
        const config = pollutantConfig[pollutant];
        primaryData = generateRandomData(days, 20, 100);

        datasets.push({
            label: config.label,
            data: primaryData,
            borderColor: config.color,
            backgroundColor: config.bgColor,
            tension: 0.3,
            fill: true,
            yAxisID: 'y',
            pointRadius: 3,
            pointHoverRadius: 6
        });
    } else {
        // 气象因素关联走势（双Y轴）
        const pollutantData = pollutantConfig[pollutant];
        const meteorData = meteorologyConfig[meteorologyFactor];

        // 污染物数据（主Y轴）
        primaryData = generateRandomData(days, 20, 100);
        datasets.push({
            label: pollutantData.label,
            data: primaryData,
            borderColor: pollutantData.color,
            backgroundColor: pollutantData.bgColor,
            tension: 0.3,
            fill: true,
            yAxisID: 'y',
            pointRadius: 3,
            pointHoverRadius: 6
        });

        // 气象数据（次Y轴）
        datasets.push({
            label: meteorData.label,
            data: generateMeteorologyData(meteorologyFactor, days),
            borderColor: meteorData.color,
            borderDash: [5, 5],
            tension: 0.3,
            fill: false,
            yAxisID: 'y1',
            pointRadius: 3,
            pointHoverRadius: 6
        });
    }

    // 找到最高点和最低点并添加标注数据集
    const { highIndices, lowIndices, highValue, lowValue } = findHighAndLowPoints(primaryData);

    // 添加最高点标注
    datasets.push({
        label: '最高点',
        data: primaryData.map((value, index) => highIndices.includes(index) ? value : null),
        backgroundColor: 'rgba(255, 0, 0, 1)', // 红色
        borderColor: 'rgba(255, 0, 0, 1)',
        borderWidth: 2,
        pointRadius: showAnnotations ? 6 : 0,
        pointHoverRadius: 8,
        showLine: false,
        yAxisID: 'y',
        tooltip: {
            callbacks: {
                label: function(context) {
                    return `最高点: ${context.raw} ${pollutantConfig[pollutant].unit}`;
                }
            }
        }
    });

    // 添加最低点标注
    datasets.push({
        label: '最低点',
        data: primaryData.map((value, index) => lowIndices.includes(index) ? value : null),
        backgroundColor: 'rgba(0, 255, 0, 1)', // 绿色
        borderColor: 'rgba(0, 255, 0, 1)',
        borderWidth: 2,
        pointRadius: showAnnotations ? 6 : 0,
        pointHoverRadius: 8,
        showLine: false,
        yAxisID: 'y',
        tooltip: {
            callbacks: {
                label: function(context) {
                    return `最低点: ${context.raw} ${pollutantConfig[pollutant].unit}`;
                }
            }
        }
    });

    // 创建新图表
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: chartType === 'pollutant'
                            ? `${pollutantConfig[pollutant].label} 浓度 (${pollutantConfig[pollutant].unit})`
                            : `${pollutantConfig[pollutant].label} 浓度 (${pollutantConfig[pollutant].unit})`
                    }
                },
                y1: chartType === 'meteorology' ? {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: `${meteorologyConfig[meteorologyFactor].label} (${meteorologyConfig[meteorologyFactor].unit})`
                    },
                    grid: {
                        drawOnChartArea: false // 不在主图表区域绘制次Y轴网格
                    }
                } : undefined,
                x: {
                    title: {
                        display: true,
                        text: '日期'
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 6
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
}

// 找到最高点和最低点
function findHighAndLowPoints(data) {
    const highValue = Math.max(...data);
    const lowValue = Math.min(...data);

    const highIndices = data.reduce((indices, value, index) => {
        if (value === highValue) indices.push(index);
        return indices;
    }, []);

    const lowIndices = data.reduce((indices, value, index) => {
        if (value === lowValue) indices.push(index);
        return indices;
    }, []);

    return { highIndices, lowIndices, highValue, lowValue };
}

// 设置事件监听器
function setupEventListeners() {
    // 图表类型切换
    document.getElementById('chart-type').addEventListener('change', function() {
        const isMeteorology = this.value === 'meteorology';
        document.getElementById('pollutant-selector').style.display = isMeteorology ? 'flex' : 'flex';
        document.getElementById('meteorology-selector').style.display = isMeteorology ? 'flex' : 'none';
        loadChartData();
    });

    // 污染物选择变化
    document.getElementById('pollutant').addEventListener('change', loadChartData);

    // 气象因素选择变化
    document.getElementById('meteorology-factor').addEventListener('change', loadChartData);

    // 时间范围变化
    document.getElementById('time-range').addEventListener('change', loadChartData);

    // 标注显示切换
    document.getElementById('toggle-annotations').addEventListener('click', function() {
        showAnnotations = !showAnnotations;
        this.innerHTML = showAnnotations ?
            '<i class="fa fa-flag"></i> 隐藏标注' :
            '<i class="fa fa-flag-o"></i> 显示标注';

        // 标注点显示状态
        if (trendChart) {
            // 最高点数据集是倒数第二个
            trendChart.data.datasets[trendChart.data.datasets.length - 2].pointRadius = showAnnotations ? 6 : 0;
            // 最低点数据集是最后一个
            trendChart.data.datasets[trendChart.data.datasets.length - 1].pointRadius = showAnnotations ? 6 : 0;
            trendChart.update();
        }
    });

    // 视图切换
    document.getElementById('chart-view').addEventListener('click', function() {
        document.getElementById('chartContainer').style.display = 'block';
        document.getElementById('tableContainer').style.display = 'none';
        this.classList.add('btn-primary');
        this.classList.remove('btn-outline-secondary');
        document.getElementById('table-view').classList.remove('btn-primary');
        document.getElementById('table-view').classList.add('btn-outline-secondary');
    });

    document.getElementById('table-view').addEventListener('click', function() {
        document.getElementById('chartContainer').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'block';
        this.classList.add('btn-primary');
        this.classList.remove('btn-outline-secondary');
        document.getElementById('chart-view').classList.remove('btn-primary');
        document.getElementById('chart-view').classList.add('btn-outline-secondary');
        loadTableData(); // 加载表格数据
    });
}

// 气象因素模拟数据
function generateMeteorologyData(type, count) {
    switch(type) {
        case 'temperature':
            return Array.from({length: count}, () => Math.floor(Math.random() * 30) + 5); // 5-35℃
        case 'humidity':
            return Array.from({length: count}, () => Math.floor(Math.random() * 60) + 20); // 20-80%
        case 'wind_speed':
            return Array.from({length: count}, () => (Math.random() * 6 + 0.5).toFixed(1)); // 0.5-6.5m/s
        case 'pressure':
            return Array.from({length: count}, () => Math.floor(Math.random() * 20) + 1000); // 1000-1020hPa
        case 'precipitation':
            return Array.from({length: count}, () => (Math.random() * 25).toFixed(1)); // 0-25mm
        default:
            return Array.from({length: count}, () => 0);
    }
}

// 加载图表数据
function loadChartData() {
    showLoader();

    // 模拟异步加载数据
    setTimeout(function() {
        initTrendChart();
        hideLoader();
    }, 800);
}

// 加载表格数据
function loadTableData() {
    showLoader();

    // 模拟异步加载数据
    setTimeout(function() {
        const tableBody = document.getElementById('dataTableBody');
        tableBody.innerHTML = '';

        const days = parseInt(document.getElementById('time-range').value);

        for (let i = 0; i < days; i++) {
            const d = new Date();
            d.setDate(d.getDate() - (days - i - 1));
            const dateStr = d.toLocaleDateString();

            row = document.createElement('tr');
            row.innerHTML = `
                <td>${dateStr}</td>
                <td>${Math.floor(Math.random() * 80) + 10}</td>
                <td>${Math.floor(Math.random() * 100) + 20}</td>
                <td>${Math.floor(Math.random() * 50) + 5}</td>
                <td>${Math.floor(Math.random() * 30) + 2}</td>
                <td>${Math.floor(Math.random() * 100) + 30}</td>
                <td>${(Math.random() * 1.5 + 0.5).toFixed(1)}</td>
                <td>${Math.floor(Math.random() * 30) + 5}</td>  <!-- 温度 -->
                <td>${Math.floor(Math.random() * 60) + 20}</td>  <!-- 湿度 -->
                <td>${Math.floor(Math.random() * 20) + 1000}</td> <!-- 气压（1000-1020hPa） -->
                <td>${(Math.random() * 25).toFixed(1)}</td>     <!-- 降水量（0-25mm） -->
                <td>${(Math.random() * 6 + 0.5).toFixed(1)}</td>  <!-- 风速 -->
                <td><span class="badge bg-success">良</span></td>
            `;
            tableBody.appendChild(row);
        }

        hideLoader();
    }, 800);
}

// 显示加载状态
function showLoader() {
    document.getElementById('chartLoader').classList.remove('d-none');
    document.getElementById('chartContainer').style.display = 'none';
    document.getElementById('tableContainer').style.display = 'none';
}

// 隐藏加载状态
function hideLoader() {
    document.getElementById('chartLoader').classList.add('d-none');
    if (document.getElementById('chart-view').classList.contains('btn-primary')) {
        document.getElementById('chartContainer').style.display = 'block';
    } else {
        document.getElementById('tableContainer').style.display = 'block';
    }
}

// 生成随机数据
function generateRandomData(count, min, max) {
    return Array.from({length: count}, () => Math.floor(Math.random() * (max - min + 1)) + min);
}
</script>
{% endblock %}