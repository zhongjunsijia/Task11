{% extends 'pollution_app/base.html' %}

{% block content %}
<!-- 保持原有导航栏和筛选控件不变 -->
<div class="container mt-4 mb-6">
    <div class="row">
        <!-- 左侧导航栏 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">分析工具</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'monitoring_analysis' %}?view=calendar" class="text-decoration-none {% if '/monitoring/' in request.path and 'view=calendar' in request.GET.urlencode %}active fw-bold{% endif %}">
                            污染日历
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'pollution_map' %}" class="text-decoration-none active fw-bold">
                            污染地图
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'sounding' %}" class="text-decoration-none {% if '/monitoring/sounding/' in request.path %}active fw-bold{% endif %}">
                            探空图
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'trend_chart' %}" class="text-decoration-none {% if '/monitoring/trend/' in request.path %}active fw-bold{% endif %}">
                            走势图
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'windrose' %}" class="text-decoration-none {% if '/windrose/' in request.path %}active fw-bold{% endif %}">
                            风玫瑰图
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 右侧地图内容区域 -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0">贺州市污染地图</h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <div class="d-flex align-items-center">
                            <label for="pollutant" class="me-2 mb-0">污染物:</label>
                            <select id="pollutant" class="form-select form-select-sm">
                                <option value="pm25" selected>PM2.5</option>
                                <option value="pm10">PM10</option>
                                <option value="so2">二氧化硫</option>
                                <option value="no2">二氧化氮</option>
                                <option value="o3">臭氧</option>
                                <option value="co">一氧化碳</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="time-range" class="me-2 mb-0">时间:</label>
                            <select id="time-range" class="form-select form-select-sm">
                                <option value="realtime" selected>实时</option>
                                <option value="day">今日平均</option>
                                <option value="week">本周平均</option>
                                <option value="month">本月平均</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="display-mode" class="me-2 mb-0">显示模式:</label>
                            <select id="display-mode" class="form-select form-select-sm">
                                <option value="markers" selected>监测点</option>
                                <option value="heatmap">热力图</option>
                            </select>
                        </div>
                        <button id="switch-map-type" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-satellite me-1"></i>切换卫星图
                        </button>
                        <button id="refresh-data" class="btn btn-sm btn-primary">
                            <i class="bi bi-refresh me-1"></i>刷新
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- 地图容器 -->
                    <div id="map-container"></div>
                    <!-- 加载提示 -->
                    <div id="map-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.8); padding: 10px 20px; border-radius: 5px; display: none; z-index: 500;">
                        <span>数据加载中...</span>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex flex-wrap gap-4">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #00e400;"></div>
                            <span>优 (0-50 μg/m³)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffff00;"></div>
                            <span>良 (51-100 μg/m³)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff7e00;"></div>
                            <span>轻度污染 (101-150 μg/m³)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ff0000;"></div>
                            <span>中度污染 (151-200 μg/m³)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #8f3f97;"></div>
                            <span>重度污染 (201-300 μg/m³)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #7e0023;"></div>
                            <span>严重污染 (>300 μg/m³)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    #map-container {
        height: calc(100vh - 180px);
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        position: relative;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        font-size: 12px;
    }

    .legend-color {
        width: 15px;
        height: 15px;
        margin-right: 5px;
        border-radius: 3px;
    }

    .heatmap-legend {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 400;
    }

    .heatmap-gradient {
        width: 150px;
        height: 15px;
        background: linear-gradient(to right, #00e400, #ffff00, #ff7e00, #ff0000, #8f3f97, #7e0023);
        margin-bottom: 5px;
    }

    .custom-marker {
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .station-label {
        background: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        margin-top: 5px;
    }

    /* 弹窗样式优化 */
    .popup-content table {
        width: 100%;
        border-collapse: collapse;
    }

    .popup-content td {
        padding: 4px 0;
        font-size: 13px;
    }

    .popup-content td:first-child {
        font-weight: 500;
    }

    .popup-content .level-badge {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
        color: white;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
        #map-container {
            height: 400px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    // 监测点数据（从后端获取）
    let monitoringStations = [];

    // 热力图数据
    let heatmapData = [];

    // 从后端获取真实数据
    async function fetchMapData() {
        try {
            const response = await fetch('/api/pollution-map/');
            const data = await response.json();
            if (data.code === 200) {
                monitoringStations = data.data.stations;
                heatmapData = data.data.heatmap;
                initMap();
            }
        } catch (error) {
            console.error('获取地图数据失败:', error);
            // 使用默认数据
            monitoringStations = [
                {
                    name: "八步区监测点",
                    lat: 24.4152,
                    lng: 111.5411,
                    pm25: 45,
                    pm10: 68,
                    so2: 12,
                    no2: 25,
                    o3: 82,
                    co: 1.2,
                    level: "优"
                },
                {
                    name: "平桂区监测点",
                    lat: 24.3767,
                    lng: 111.3822,
                    pm25: 62,
                    pm10: 95,
                    so2: 18,
                    no2: 32,
                    o3: 75,
                    co: 1.5,
                    level: "良"
                },
                {
                    name: "昭平县监测点",
                    lat: 24.1806,
                    lng: 110.9719,
                    pm25: 35,
                    pm10: 52,
                    so2: 9,
                    no2: 18,
                    o3: 90,
                    co: 0.8,
                    level: "优"
                },
                {
                    name: "钟山县监测点",
                    lat: 24.5722,
                    lng: 111.2078,
                    pm25: 112,
                    pm10: 165,
                    so2: 25,
                    no2: 45,
                    o3: 68,
                    co: 2.1,
                    level: "轻度污染"
                },
                {
                    name: "富川县监测点",
                    lat: 24.8206,
                    lng: 111.2006,
                    pm25: 58,
                    pm10: 88,
                    so2: 15,
                    no2: 28,
                    o3: 85,
                    co: 1.3,
                    level: "良"
                }
            ];
            heatmapData = [
                [24.41, 111.55, 42], [24.43, 111.58, 45], [24.40, 111.52, 38],
                [24.38, 111.39, 60], [24.37, 111.42, 65], [24.39, 111.36, 58],
                [24.18, 110.97, 35], [24.17, 110.95, 32], [24.19, 110.99, 38],
                [24.57, 111.21, 112], [24.58, 111.23, 108], [24.56, 111.19, 115],
                [24.82, 111.20, 58], [24.83, 111.22, 62], [24.81, 111.18, 55]
            ];
            initMap();
        }
    }

    // 全局变量
    let markersLayer, heatmapLayer;
    let currentDisplayMode = 'markers'; // 默认为监测点模式
    let map, streetLayer, satelliteLayer;
    let currentMapType = 'street';

    // 根据污染等级获取颜色
    function getPollutionColor(level) {
        switch(level) {
            case "优": return "#00e400";
            case "良": return "#ffff00";
            case "轻度污染": return "#ff7e00";
            case "中度污染": return "#ff0000";
            case "重度污染": return "#8f3f97";
            case "严重污染": return "#7e0023";
            default: return "#cccccc";
        }
    }

    // 获取污染物等级（扩展支持多种污染物）
    function getPollutantLevel(value, type) {
        switch(type) {
            case 'pm25':
                if (value <= 35) return "优";
                else if (value <= 75) return "良";
                else if (value <= 115) return "轻度污染";
                else if (value <= 150) return "中度污染";
                else if (value <= 250) return "重度污染";
                else return "严重污染";
            case 'pm10':
                if (value <= 50) return "优";
                else if (value <= 150) return "良";
                else if (value <= 250) return "轻度污染";
                else if (value <= 350) return "中度污染";
                else if (value <= 420) return "重度污染";
                else return "严重污染";
            case 'so2':
                if (value <= 50) return "优";
                else if (value <= 150) return "良";
                else if (value <= 475) return "轻度污染";
                else if (value <= 800) return "中度污染";
                else if (value <= 1600) return "重度污染";
                else return "严重污染";
            case 'no2':
                if (value <= 40) return "优";
                else if (value <= 80) return "良";
                else if (value <= 180) return "轻度污染";
                else if (value <= 280) return "中度污染";
                else if (value <= 565) return "重度污染";
                else return "严重污染";
            case 'o3':
                if (value <= 100) return "优";
                else if (value <= 160) return "良";
                else if (value <= 215) return "轻度污染";
                else if (value <= 265) return "中度污染";
                else if (value <= 800) return "重度污染";
                else return "严重污染";
            case 'co':
                if (value <= 2) return "优";
                else if (value <= 4) return "良";
                else if (value <= 14) return "轻度污染";
                else if (value <= 24) return "中度污染";
                else if (value <= 36) return "重度污染";
                else return "严重污染";
            default: return "未知";
        }
    }

    // 获取当前选中的污染物类型
    function getSelectedPollutant() {
        return document.getElementById('pollutant').value;
    }

    // 更新监测点数据（用于刷新功能）
    function updateStationData() {
        // 模拟数据更新，包含所有污染物
        monitoringStations.forEach(station => {
            // 更新PM2.5
            const pm25波动 = Math.floor(station.pm25 * (0.9 + Math.random() * 0.2));
            station.pm25 = Math.max(0, pm25波动);

            // 更新PM10
            const pm10波动 = Math.floor(station.pm10 * (0.9 + Math.random() * 0.2));
            station.pm10 = Math.max(0, pm10波动);

            // 更新SO2
            const so2波动 = Math.floor(station.so2 * (0.9 + Math.random() * 0.2));
            station.so2 = Math.max(0, so2波动);

            // 更新NO2
            const no2波动 = Math.floor(station.no2 * (0.9 + Math.random() * 0.2));
            station.no2 = Math.max(0, no2波动);

            // 更新O3
            const o3波动 = Math.floor(station.o3 * (0.9 + Math.random() * 0.2));
            station.o3 = Math.max(0, o3波动);

            // 更新CO
            const co波动 = (station.co * (0.9 + Math.random() * 0.2)).toFixed(1);
            station.co = parseFloat(co波动);

            // 根据PM2.5更新总体污染等级（保持原逻辑）
            if (station.pm25 <= 50) station.level = "优";
            else if (station.pm25 <= 100) station.level = "良";
            else if (station.pm25 <= 150) station.level = "轻度污染";
            else if (station.pm25 <= 200) station.level = "中度污染";
            else if (station.pm25 <= 300) station.level = "重度污染";
            else station.level = "严重污染";
        });

        // 重新创建监测点图层
        if (markersLayer) map.removeLayer(markersLayer);
        createMarkersLayer();
        if (currentDisplayMode === 'markers') {
            markersLayer.addTo(map);
        }
    }

    // 创建监测点图层（修改后）
    function createMarkersLayer() {
        markersLayer = L.layerGroup();
        // 获取当前选中的污染物
        const selectedPollutant = getSelectedPollutant();

        monitoringStations.forEach(station => {
            // 根据选中的污染物获取对应数值和等级
            const pollutantValue = station[selectedPollutant];
            const pollutantLevel = getPollutantLevel(pollutantValue, selectedPollutant);
            const markerColor = getPollutionColor(pollutantLevel);

            // 创建自定义标记（显示选中污染物的数值）
            const markerIcon = L.divIcon({
                html: `
                    <div class="custom-marker" style="width: 30px; height: 30px; background-color: ${markerColor}">
                        ${selectedPollutant === 'co' ? pollutantValue.toFixed(1) : pollutantValue}
                    </div>
                    <div class="station-label">${station.name}</div>
                `,
                className: 'custom-marker-container',
                iconSize: [80, 50],
                iconAnchor: [40, 25]
            });

            // 添加标记到图层
            const marker = L.marker([station.lat, station.lng], { icon: markerIcon }).addTo(markersLayer);

            // 点击弹窗显示详细信息（包含所有污染物）
            marker.bindPopup(`
                <div class="popup-content" style="width: 240px;">
                    <h5 style="margin: 0 0 8px 0;">${station.name}</h5>
                    <table>
                        <tr>
                            <td>PM2.5浓度:</td>
                            <td>${station.pm25} μg/m³
                                <span class="level-badge" style="background-color: ${getPollutionColor(getPollutantLevel(station.pm25, 'pm25'))}">
                                    ${getPollutantLevel(station.pm25, 'pm25')}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>PM10浓度:</td>
                            <td>${station.pm10} μg/m³
                                <span class="level-badge" style="background-color: ${getPollutionColor(getPollutantLevel(station.pm10, 'pm10'))}">
                                    ${getPollutantLevel(station.pm10, 'pm10')}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>二氧化硫(SO2):</td>
                            <td>${station.so2} μg/m³
                                <span class="level-badge" style="background-color: ${getPollutionColor(getPollutantLevel(station.so2, 'so2'))}">
                                    ${getPollutantLevel(station.so2, 'so2')}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>二氧化氮(NO2):</td>
                            <td>${station.no2} μg/m³
                                <span class="level-badge" style="background-color: ${getPollutionColor(getPollutantLevel(station.no2, 'no2'))}">
                                    ${getPollutantLevel(station.no2, 'no2')}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>臭氧(O3):</td>
                            <td>${station.o3} μg/m³
                                <span class="level-badge" style="background-color: ${getPollutionColor(getPollutantLevel(station.o3, 'o3'))}">
                                    ${getPollutantLevel(station.o3, 'o3')}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>一氧化碳(CO):</td>
                            <td>${station.co} mg/m³
                                <span class="level-badge" style="background-color: ${getPollutionColor(getPollutantLevel(station.co, 'co'))}">
                                    ${getPollutantLevel(station.co, 'co')}
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>
            `);
        });
    }

    // 初始化地图
    function initMap() {
        // 显示加载提示
        document.getElementById('map-loading').style.display = 'block';

        // 创建地图实例，聚焦贺州市中心
        map = L.map('map-container').setView([24.42, 111.53], 10);

        // 高德街道图图层
        streetLayer = L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            subdomains: "1234",
            attribution: '© 高德地图'
        }).addTo(map);

        // 高德卫星图图层
        satelliteLayer = L.tileLayer('https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
            subdomains: "1234",
            attribution: '© 高德地图'
        });

        // 创建监测点图层
        createMarkersLayer();

        // 创建热力图图层
        heatmapLayer = L.heatLayer(heatmapData, {
            radius: 25,
            blur: 15,
            maxZoom: 17,
            gradient: {
                0.0: '#00e400',
                0.2: '#ffff00',
                0.4: '#ff7e00',
                0.6: '#ff0000',
                0.8: '#8f3f97',
                1.0: '#7e0023'
            }
        });

        // 默认添加监测点图层
        markersLayer.addTo(map);

        // 添加比例尺
        L.control.scale({imperial: false}).addTo(map);

        // 隐藏加载提示并添加额外监测点
        setTimeout(() => {
            document.getElementById('map-loading').style.display = 'none';
            addMonitoringPoints();
        }, 800);
    }

    // 热力图图例
    function addHeatmapLegend() {
        const existingLegend = document.getElementById('heatmap-legend');
        if (existingLegend) existingLegend.remove();

        const legend = document.createElement('div');
        legend.id = 'heatmap-legend';
        legend.className = 'heatmap-legend';
        legend.innerHTML = `
            <div class="heatmap-gradient"></div>
            <div class="d-flex justify-content-between text-xs">
                <span>0</span>
                <span>50</span>
                <span>100</span>
                <span>150</span>
                <span>200</span>
                <span>300+</span>
            </div>
        `;
        document.getElementById('map-container').appendChild(legend);
    }

    // 移除热力图图例
    function removeHeatmapLegend() {
        const legend = document.getElementById('heatmap-legend');
        if (legend) legend.remove();
    }

    // 贺州市区监测点标记
    function addMonitoringPoints() {
        // 扩展后的监测点数据
        const monitoringPoints = [
            {
                name: "环保小区",
                lat: 24.42,
                lng: 111.53,
                pm25: 42,
                pm10: 65,
                so2: 10,
                no2: 22,
                o3: 78,
                co: 1.1
            },
            {
                name: "政协大楼",
                lat: 24.40,
                lng: 111.57,
                pm25: 38,
                pm10: 58,
                so2: 8,
                no2: 19,
                o3: 85,
                co: 0.9
            },
            {
                name: "西湾",
                lat: 24.46,
                lng: 111.49,
                pm25: 45,
                pm10: 72,
                so2: 14,
                no2: 26,
                o3: 75,
                co: 1.3
            }
        ];

        // 创建自定义图标
        const pointIcon = L.divIcon({
            html: '<div style="width: 12px; height: 12px; background-color: #3388ff; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px #3388ff;"></div>',
            className: 'monitoring-point',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });

        // 添加标记到地图（弹窗包含所有污染物）
        monitoringPoints.forEach(point => {
            L.marker([point.lat, point.lng], {icon: pointIcon})
                .addTo(map)
                .bindPopup(`
                    <div class="popup-content" style="width: 220px;">
                        <h5 style="margin: 0 0 8px 0;">${point.name}</h5>
                        <table>
                            <tr>
                                <td>PM2.5:</td>
                                <td>${point.pm25} μg/m³</td>
                            </tr>
                            <tr>
                                <td>PM10:</td>
                                <td>${point.pm10} μg/m³</td>
                            </tr>
                            <tr>
                                <td>SO2:</td>
                                <td>${point.so2} μg/m³</td>
                            </tr>
                            <tr>
                                <td>NO2:</td>
                                <td>${point.no2} μg/m³</td>
                            </tr>
                            <tr>
                                <td>O3:</td>
                                <td>${point.o3} μg/m³</td>
                            </tr>
                            <tr>
                                <td>CO:</td>
                                <td>${point.co} mg/m³</td>
                            </tr>
                        </table>
                    </div>
                `);
        });
    }

    // 根据PM2.5值获取污染等级
    function getLevelByPM25(value) {
        if (value <= 50) return "优";
        else if (value <= 100) return "良";
        else if (value <= 150) return "轻度污染";
        else if (value <= 200) return "中度污染";
        else if (value <= 300) return "重度污染";
        else return "严重污染";
    }

    // 页面加载完成后初始化地图
    window.onload = function() {
        fetchMapData();

        // 切换显示模式（监测点/热力图）
        document.getElementById('display-mode').addEventListener('change', function(e) {
            const mode = e.target.value;
            if (mode === 'markers') {
                map.removeLayer(heatmapLayer);
                markersLayer.addTo(map);
                removeHeatmapLegend();
            } else {
                map.removeLayer(markersLayer);
                heatmapLayer.addTo(map);
                addHeatmapLegend();
            }
            currentDisplayMode = mode;
        });

        // 切换地图类型（街道图/卫星图）
        document.getElementById('switch-map-type').addEventListener('click', function() {
            if (currentMapType === 'street') {
                map.removeLayer(streetLayer);
                satelliteLayer.addTo(map);
                currentMapType = 'satellite';
            } else {
                map.removeLayer(satelliteLayer);
                streetLayer.addTo(map);
                currentMapType = 'street';
            }
        });

        // 刷新数据
        document.getElementById('refresh-data').addEventListener('click', function() {
            document.getElementById('map-loading').style.display = 'block';
            setTimeout(() => {
                updateStationData();
                document.getElementById('map-loading').style.display = 'none';
            }, 600);
        });
    };

    // 监听污染物选择框变化，自动刷新标记
    document.getElementById('pollutant').addEventListener('change', function() {
        document.getElementById('map-loading').style.display = 'block';
        // 模拟加载延迟
        setTimeout(() => {
            updateStationData(); // 重新加载数据并刷新标记
            document.getElementById('map-loading').style.display = 'none';
        }, 500);
    });

    // 确保刷新按钮点击时也能更新选中的污染物
    document.getElementById('refresh-data').addEventListener('click', function() {
        document.getElementById('map-loading').style.display = 'block';
        setTimeout(() => {
            updateStationData();
            document.getElementById('map-loading').style.display = 'none';
        }, 500);
    });
</script>
{% endblock %}