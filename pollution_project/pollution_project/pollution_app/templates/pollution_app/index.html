{% extends 'pollution_app/base.html' %}

{% block title %}气象污染预测系统 - 首页{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- 系统介绍横幅 -->
    <div class="bg-primary text-white p-5 rounded-3 mb-6">
        <h1 class="display-5 fw-bold">气象污染预测系统</h1>
        <p class="col-md-8 fs-4">实时监测、精准预测、全面分析空气质量状况，为您提供专业的污染防控参考</p>
        <a href="{% url 'monitoring_analysis' %}" class="btn btn-light btn-lg mt-3">开始分析 <i class="bi bi-arrow-right"></i></a>
    </div>

    <!-- 核心功能卡片 -->
    <div class="row mb-6">
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-primary"><i class="bi bi-bar-chart-line me-2"></i>实时监测</h5>
                    <p class="card-text">实时采集并展示各地区空气质量数据，包括PM2.5、PM10、NO₂等多种污染物浓度</p>
                    <a href="{% url 'pollution_map' %}" class="btn btn-outline-primary">查看详情</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-success"><i class="bi bi-clock-history me-2"></i>污染预测</h5>
                    <p class="card-text">基于历史数据和气象条件，预测未来7天空气质量变化趋势，提前预警污染风险</p>
                    <a href="{% url 'air_pollution_forecast' %}" class="btn btn-outline-success">查看预测</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-info"><i class="bi bi-file-earmark-text me-2"></i>数据分析</h5>
                    <p class="card-text">提供多种可视化分析工具，包括风玫瑰图、走势图和探空图，深入解析污染成因</p>
                    <a href="{% url 'trend_chart' %}" class="btn btn-outline-info">开始分析</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 关键指标展示 -->
    <div class="card mb-6">
        <div class="card-header bg-light">
            <h5 class="mb-0">贺州市今日空气质量概览</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3 mb-3">
                    <div class="p-3 bg-success bg-opacity-10 rounded">
                        <h6>PM2.5</h6>
                        <p class="display-5 fw-bold" id="hezhouPm25">55 <small>μg/m³</small></p>
                        <p class="text-success" id="hezhouPm25Level">良</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="p-3 bg-warning bg-opacity-10 rounded">
                        <h6>PM10</h6>
                        <p class="display-5 fw-bold" id="hezhouPm10">96 <small>μg/m³</small></p>
                        <p class="text-success" id="hezhouPm10Level">良</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="p-3 bg-success bg-opacity-10 rounded">
                        <h6>O₃</h6>
                        <p class="display-5 fw-bold" id="hezhouO3">58 <small>μg/m³</small></p>
                        <p class="text-success" id="hezhouO3Level">优</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="p-3 bg-primary bg-opacity-10 rounded">
                        <h6>AQI指数</h6>
                        <p class="display-5 fw-bold" id="hezhouAqi">67</p>
                        <p class="text-info" id="hezhouAqiLevel">良</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计方框 -->
    <div class="row mb-6">
        <!-- 全区总体空气质量 -->
        <div class="col-md-3 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-info bg-opacity-10">
                    <h5 class="mb-0 text-info"><i class="bi bi-globe me-2"></i>全区总体空气质量</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>平均AQI：</strong>72</p>
                    <p class="mb-0"><strong>监测城市：</strong>338个</p>
                </div>
            </div>
        </div>

        <!-- 优良城市数量 -->
        <div class="col-md-3 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-success bg-opacity-10">
                    <h5 class="mb-0 text-success"><i class="bi bi-check-circle me-2"></i>优良城市数量</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>数量：</strong>245个 (72.5%)</p>
                    <p class="mb-0 text-success"><i class="bi bi-arrow-up me-1"></i>较昨日上升2.3%</p>
                </div>
            </div>
        </div>

        <!-- 轻度污染城市数量 -->
        <div class="col-md-3 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-warning bg-opacity-10">
                    <h5 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>轻度污染城市数量</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>数量：</strong>78个 (23.1%)</p>
                    <p class="mb-0 text-danger"><i class="bi bi-arrow-up me-1"></i>较昨日上升1.2%</p>
                </div>
            </div>
        </div>

        <!-- 中度及以上污染城市数量 -->
        <div class="col-md-3 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-danger bg-opacity-10">
                    <h5 class="mb-0 text-danger"><i class="bi bi-exclamation-circle me-2"></i>中度及以上污染城市数量</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>数量：</strong>15个 (4.4%)</p>
                    <p class="mb-0 text-success"><i class="bi bi-arrow-down me-1"></i>较昨日下降3.5%</p>
                </div>
            </div>
        </div>
    </div>


<div class="row">
    <!-- 全区地市AQI等级分布 -->
    <div class="col-md-6 mb-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">全区地市AQI等级分布</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div style="height: 300px;">
                            <canvas id="aqiPieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 贺州市AQI等级分布 -->
    <div class="col-md-6 mb-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">贺州市AQI等级分布</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div style="height: 300px;">
                            <canvas id="hezhouAqiPieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- 地区排名与趋势 -->
    <div class="row">
        <div class="col-md-6 mb-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">全区各地市AQI排名</h5>
                        <div>
                            <button id="sortAscBtn" class="btn btn-sm btn-outline-primary active">
                                <i class="bi bi-sort-numeric-down"></i> 由低到高
                            </button>
                            <button id="sortDescBtn" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-sort-numeric-up"></i> 由高到低
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="overflow-x-auto">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>城市</th>
                                    <th>AQI指数</th>
                                    <th>空气质量</th>
                                </tr>
                            </thead>
                            <tbody id="aqiRankingTable">
                                <!-- 默认显示由低到高排序 -->
                                <tr>
                                    <td>1</td>
                                    <td>伊犁</td>
                                    <td data-aqi="35">35</td>
                                    <td><span class="badge bg-success">优</span></td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td>齐齐哈尔</td>
                                    <td data-aqi="42">42</td>
                                    <td><span class="badge bg-success">优</span></td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td>青岛</td>
                                    <td data-aqi="48">48</td>
                                    <td><span class="badge bg-success">良好</span></td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td>潍坊</td>
                                    <td data-aqi="52">52</td>
                                    <td><span class="badge bg-success">良好</span></td>
                                </tr>
                                <tr>
                                    <td>5</td>
                                    <td>呼和浩特</td>
                                    <td data-aqi="58">58</td>
                                    <td><span class="badge bg-success">良好</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">贺州市近7天污染物趋势</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="homeTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 贺州市近7天污染物浓度表 -->
    <div class="card mb-6">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">贺州市近7天污染物浓度表</h5>
                <div>
                    <button id="exportCsvBtn" class="btn btn-secondary me-2">
                        <i class="bi bi-file-earmark-text"></i> 导出CSV
                    </button>
                    <button id="exportExcelBtn" class="btn btn-success">
                        <i class="bi bi-file-earmark-spreadsheet"></i> 导出Excel
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- 表格容器 -->
            <div class="overflow-x-auto">
                <!-- 贺州市近7天污染物数据表格 -->
                <table id="hezhouPollutantTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>PM2.5(μg/m³)</th>
                            <th>PM10(μg/m³)</th>
                            <th>SO₂(μg/m³)</th>
                            <th>CO(mg/m³)</th>
                            <th>NO₂(μg/m³)</th>
                            <th>O₃(μg/m³)</th>
                        </tr>
                    </thead>
                    <tbody id="hezhouPollutantTableBody">
                        <!-- 数据将通过JavaScript动态填充 -->
                        <tr>
                            <td colspan="7" class="text-center">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
<!-- 引入SheetJS库用于数据导出 -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 全区地市AQI等级分布饼图
    const pieCtx = document.getElementById('aqiPieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: ['优良（0-100）', '轻度污染（101-105）', '中度污染（151-200）', '重度污染（>200）'],
            datasets: [{
                data: [65, 25, 8, 2],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.7)',   // 绿色-优良
                    'rgba(255, 193, 7, 0.7)',  // 黄色-轻度污染
                    'rgba(220, 53, 69, 0.7)',  // 红色-中度污染
                    'rgba(108, 117, 125, 0.7)' // 灰色-重度污染
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(220, 53, 69, 1)',
                    'rgba(108, 117, 125, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value}个地市 (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // 贺州市AQI等级分布饼图
    const hezhouPieCtx = document.getElementById('hezhouAqiPieChart').getContext('2d');
    new Chart(hezhouPieCtx, {
        type: 'pie',
        data: {
            labels: ['优良（0-100）', '轻度污染（101-105）', '中度污染（151-200）', '重度污染（>200）'],
            datasets: [{
                data: [85, 10, 3, 2],  // 贺州市各等级占比数据（示例）
                backgroundColor: [
                    'rgba(40, 167, 69, 0.7)',   // 绿色-优良
                    'rgba(255, 193, 7, 0.7)',  // 黄色-轻度污染
                    'rgba(237, 125, 49, 0.7)', // 橙色-中度污染
                    'rgba(220, 53, 69, 0.7)'   // 红色-重度污染
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(237, 125, 49, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value}个区县 (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // （贺州市）近7天污染物趋势图
    function loadHezhouTrendData() {
        const trendCtx = document.getElementById('homeTrendChart').getContext('2d');
        
        // 创建一个初始的空图表
        const trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'PM2.5',
                        data: [],
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'PM10',
                        data: [],
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'O₃',
                        data: [],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'SO₂',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'NO₂',
                        data: [],
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'CO',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '浓度 (μg/m³)'
                        }
                    }
                }
            }
        });
        
        // 从API获取真实数据
        fetch('/api/hezhou-trend/')
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 更新图表数据
                    const responseData = data.data;
                    trendChart.data.labels = responseData.dates;
                    trendChart.data.datasets[0].data = responseData.pm25;
                    trendChart.data.datasets[1].data = responseData.pm10;
                    trendChart.data.datasets[2].data = responseData.o3;
                    trendChart.data.datasets[3].data = responseData.so2;
                    trendChart.data.datasets[4].data = responseData.no2;
                    trendChart.data.datasets[5].data = responseData.co;
                    trendChart.update();
                } else {
                    console.error('获取贺州趋势数据失败:', data.message);
                    // 使用默认数据作为 fallback
                    useDefaultTrendData(trendChart);
                }
            })
            .catch(error => {
                console.error('API请求失败:', error);
                // 使用默认数据作为 fallback
                useDefaultTrendData(trendChart);
            });
    }
    
    function useDefaultTrendData(chart) {
        // 计算最近7天的具体日期
        function getRecentDates() {
            const dates = [];
            const today = new Date();
            
            // 从7天前开始，到今天结束
            for (let i = 7; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                // 格式化日期为 MM-DD
                const formattedDate = `${date.getMonth() + 1}-${date.getDate()}`;
                dates.push(formattedDate);
            }
            return dates;
        }
        
        // 使用默认数据
        chart.data.labels = getRecentDates();
        chart.data.datasets[0].data = [42, 38, 45, 52, 49, 40, 35, 35];
        chart.data.datasets[1].data = [65, 70, 78, 82, 85, 80, 75, 78];
        chart.data.datasets[2].data = [45, 48, 50, 55, 53, 51, 50, 52];
        chart.data.datasets[3].data = [12, 15, 14, 18, 16, 13, 11, 10];
        chart.data.datasets[4].data = [28, 32, 35, 30, 25, 22, 20, 24];
        chart.data.datasets[5].data = [1.2, 1.5, 1.4, 1.6, 1.3, 1.1, 1.0, 1.2];
        chart.update();
    }
    
    // 加载贺州趋势数据
    loadHezhouTrendData();
    
    // 加载贺州市近7天污染物数据
    loadHezhouPollutantData();
    
    // 加载贺州市今日空气质量数据
    loadHezhouTodayAirQuality();

    // 加载贺州市近7天污染物数据
    function loadHezhouPollutantData() {
        const tableBody = document.getElementById('hezhouPollutantTableBody');
        
        // 从API获取真实数据
        fetch('/api/hezhou-trend/')
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 清空表格
                    tableBody.innerHTML = '';
                    
                    // 填充数据
                    const responseData = data.data;
                    for (let i = 0; i < responseData.dates.length; i++) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${responseData.dates[i]}</td>
                            <td>${responseData.pm25[i]}</td>
                            <td>${responseData.pm10[i]}</td>
                            <td>${responseData.so2[i]}</td>
                            <td>${responseData.co[i]}</td>
                            <td>${responseData.no2[i]}</td>
                            <td>${responseData.o3[i]}</td>
                        `;
                        tableBody.appendChild(row);
                    }
                } else {
                    console.error('获取贺州污染物数据失败:', data.message);
                    // 使用默认数据作为 fallback
                    useDefaultHezhouPollutantData();
                }
            })
            .catch(error => {
                console.error('API请求失败:', error);
                // 使用默认数据作为 fallback
                useDefaultHezhouPollutantData();
            });
    }
    
    function useDefaultHezhouPollutantData() {
        const tableBody = document.getElementById('hezhouPollutantTableBody');
        
        // 计算最近7天的具体日期
        function getRecentDates() {
            const dates = [];
            const today = new Date();
            
            // 从7天前开始，到今天结束
            for (let i = 7; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                // 格式化日期为 MM-DD
                const formattedDate = `${date.getMonth() + 1}-${date.getDate()}`;
                dates.push(formattedDate);
            }
            return dates;
        }
        
        const dates = getRecentDates();
        const defaultData = {
            pm25: [42, 38, 45, 52, 49, 40, 35, 35],
            pm10: [65, 70, 78, 82, 85, 80, 75, 78],
            so2: [12, 15, 14, 18, 16, 13, 11, 10],
            co: [1.2, 1.5, 1.4, 1.6, 1.3, 1.1, 1.0, 1.2],
            no2: [28, 32, 35, 30, 25, 22, 20, 24],
            o3: [45, 48, 50, 55, 53, 51, 50, 52]
        };
        
        // 清空表格
        tableBody.innerHTML = '';
        
        // 填充默认数据
        for (let i = 0; i < dates.length; i++) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${dates[i]}</td>
                <td>${defaultData.pm25[i]}</td>
                <td>${defaultData.pm10[i]}</td>
                <td>${defaultData.so2[i]}</td>
                <td>${defaultData.co[i]}</td>
                <td>${defaultData.no2[i]}</td>
                <td>${defaultData.o3[i]}</td>
            `;
            tableBody.appendChild(row);
        }
    }
    
    // 加载贺州市今日空气质量数据
    function loadHezhouTodayAirQuality() {
        // 从API获取真实数据
        fetch('/api/hezhou-trend/')
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const responseData = data.data;
                    
                    // 优先使用API返回的current_*字段（如果存在）
                    if (responseData.current_pm25 !== undefined && responseData.current_pm10 !== undefined && responseData.current_o3 !== undefined && responseData.current_aqi !== undefined) {
                        console.log('使用API返回的实时数据');
                        
                        // 更新PM2.5
                        document.getElementById('hezhouPm25').innerHTML = `${responseData.current_pm25} <small>μg/m³</small>`;
                        document.getElementById('hezhouPm25Level').textContent = getPollutantLevel('pm25', responseData.current_pm25);
                        document.getElementById('hezhouPm25Level').className = getPollutantLevelClass('pm25', responseData.current_pm25);
                        
                        // 更新PM10
                        document.getElementById('hezhouPm10').innerHTML = `${responseData.current_pm10} <small>μg/m³</small>`;
                        document.getElementById('hezhouPm10Level').textContent = getPollutantLevel('pm10', responseData.current_pm10);
                        document.getElementById('hezhouPm10Level').className = getPollutantLevelClass('pm10', responseData.current_pm10);
                        
                        // 更新O3
                        document.getElementById('hezhouO3').innerHTML = `${responseData.current_o3} <small>μg/m³</small>`;
                        document.getElementById('hezhouO3Level').textContent = getPollutantLevel('o3', responseData.current_o3);
                        document.getElementById('hezhouO3Level').className = getPollutantLevelClass('o3', responseData.current_o3);
                        
                        // 更新AQI
                        const aqiValue = responseData.current_aqi;
                        let aqiLevel, aqiLevelClass;
                        if (aqiValue <= 50) {
                            aqiLevel = '优';
                            aqiLevelClass = 'text-success';
                        } else if (aqiValue <= 100) {
                            aqiLevel = '良';
                            aqiLevelClass = 'text-info';
                        } else if (aqiValue <= 150) {
                            aqiLevel = '轻度污染';
                            aqiLevelClass = 'text-warning';
                        } else if (aqiValue <= 200) {
                            aqiLevel = '中度污染';
                            aqiLevelClass = 'text-primary';
                        } else if (aqiValue <= 300) {
                            aqiLevel = '重度污染';
                            aqiLevelClass = 'text-danger';
                        } else {
                            aqiLevel = '严重污染';
                            aqiLevelClass = 'text-dark';
                        }
                        document.getElementById('hezhouAqi').textContent = aqiValue;
                        document.getElementById('hezhouAqiLevel').textContent = aqiLevel;
                        document.getElementById('hezhouAqiLevel').className = aqiLevelClass;
                    } else {
                        // 使用最新的数据（数组的最后一个元素）
                        console.log('使用趋势数据中的最新值');
                        const latestIndex = responseData.dates.length - 1;
                        
                        // 更新PM2.5
                        document.getElementById('hezhouPm25').innerHTML = `${responseData.pm25[latestIndex]} <small>μg/m³</small>`;
                        document.getElementById('hezhouPm25Level').textContent = getPollutantLevel('pm25', responseData.pm25[latestIndex]);
                        document.getElementById('hezhouPm25Level').className = getPollutantLevelClass('pm25', responseData.pm25[latestIndex]);
                        
                        // 更新PM10
                        document.getElementById('hezhouPm10').innerHTML = `${responseData.pm10[latestIndex]} <small>μg/m³</small>`;
                        document.getElementById('hezhouPm10Level').textContent = getPollutantLevel('pm10', responseData.pm10[latestIndex]);
                        document.getElementById('hezhouPm10Level').className = getPollutantLevelClass('pm10', responseData.pm10[latestIndex]);
                        
                        // 更新O3
                        document.getElementById('hezhouO3').innerHTML = `${responseData.o3[latestIndex]} <small>μg/m³</small>`;
                        document.getElementById('hezhouO3Level').textContent = getPollutantLevel('o3', responseData.o3[latestIndex]);
                        document.getElementById('hezhouO3Level').className = getPollutantLevelClass('o3', responseData.o3[latestIndex]);
                        
                        // 更新AQI
                        const aqi = calculateAqiFromPollutants({
                            pm25: responseData.pm25[latestIndex],
                            pm10: responseData.pm10[latestIndex],
                            o3: responseData.o3[latestIndex],
                            no2: responseData.no2[latestIndex],
                            so2: responseData.so2[latestIndex],
                            co: responseData.co[latestIndex]
                        });
                        document.getElementById('hezhouAqi').textContent = aqi.value;
                        document.getElementById('hezhouAqiLevel').textContent = aqi.level;
                        document.getElementById('hezhouAqiLevel').className = aqi.levelClass;
                    }
                } else {
                    console.error('获取贺州空气质量数据失败:', data.message);
                    // 使用默认数据
                    useDefaultHezhouTodayAirQuality();
                }
            })
            .catch(error => {
                console.error('API请求失败:', error);
                // 使用默认数据
                useDefaultHezhouTodayAirQuality();
            });
    }
    
    // 获取污染物等级
    function getPollutantLevel(pollutant, value) {
        const levels = {
            pm25: [
                { max: 35, level: '优' },
                { max: 75, level: '良' },
                { max: 115, level: '轻度污染' },
                { max: 150, level: '中度污染' },
                { max: 250, level: '重度污染' },
                { max: Infinity, level: '严重污染' }
            ],
            pm10: [
                { max: 50, level: '优' },
                { max: 150, level: '良' },
                { max: 250, level: '轻度污染' },
                { max: 350, level: '中度污染' },
                { max: 420, level: '重度污染' },
                { max: Infinity, level: '严重污染' }
            ],
            o3: [
                { max: 100, level: '优' },
                { max: 160, level: '良' },
                { max: 215, level: '轻度污染' },
                { max: 265, level: '中度污染' },
                { max: 800, level: '重度污染' },
                { max: Infinity, level: '严重污染' }
            ]
        };
        
        const levelArray = levels[pollutant] || levels.pm25;
        for (const level of levelArray) {
            if (value <= level.max) {
                return level.level;
            }
        }
        return '未知';
    }
    
    // 获取污染物等级样式类
    function getPollutantLevelClass(pollutant, value) {
        const level = getPollutantLevel(pollutant, value);
        const classMap = {
            '优': 'text-success',
            '良': 'text-info',
            '轻度污染': 'text-warning',
            '中度污染': 'text-primary',
            '重度污染': 'text-danger',
            '严重污染': 'text-dark'
        };
        return classMap[level] || 'text-muted';
    }
    
    // 根据污染物浓度计算AQI
    function calculateAqiFromPollutants(pollutants) {
        // 简化的AQI计算
        const aqiValues = [];
        
        // PM2.5 AQI计算
        if (pollutants.pm25 <= 35) {
            aqiValues.push(Math.round(pollutants.pm25 / 35 * 50));
        } else if (pollutants.pm25 <= 75) {
            aqiValues.push(Math.round(50 + (pollutants.pm25 - 35) / 40 * 50));
        } else if (pollutants.pm25 <= 115) {
            aqiValues.push(Math.round(100 + (pollutants.pm25 - 75) / 40 * 50));
        } else {
            aqiValues.push(Math.round(150 + (pollutants.pm25 - 115) / 35 * 50));
        }
        
        // PM10 AQI计算
        if (pollutants.pm10 <= 50) {
            aqiValues.push(Math.round(pollutants.pm10 / 50 * 50));
        } else if (pollutants.pm10 <= 150) {
            aqiValues.push(Math.round(50 + (pollutants.pm10 - 50) / 100 * 50));
        } else if (pollutants.pm10 <= 250) {
            aqiValues.push(Math.round(100 + (pollutants.pm10 - 150) / 100 * 50));
        } else {
            aqiValues.push(Math.round(150 + (pollutants.pm10 - 250) / 100 * 50));
        }
        
        // O3 AQI计算
        if (pollutants.o3 <= 100) {
            aqiValues.push(Math.round(pollutants.o3 / 100 * 50));
        } else if (pollutants.o3 <= 160) {
            aqiValues.push(Math.round(50 + (pollutants.o3 - 100) / 60 * 50));
        } else if (pollutants.o3 <= 215) {
            aqiValues.push(Math.round(100 + (pollutants.o3 - 160) / 55 * 50));
        } else {
            aqiValues.push(Math.round(150 + (pollutants.o3 - 215) / 50 * 50));
        }
        
        // 取最大值作为AQI
        const aqiValue = Math.max(...aqiValues);
        
        // 确定AQI等级
        let level, levelClass;
        if (aqiValue <= 50) {
            level = '优';
            levelClass = 'text-success';
        } else if (aqiValue <= 100) {
            level = '良';
            levelClass = 'text-info';
        } else if (aqiValue <= 150) {
            level = '轻度污染';
            levelClass = 'text-warning';
        } else if (aqiValue <= 200) {
            level = '中度污染';
            levelClass = 'text-primary';
        } else if (aqiValue <= 300) {
            level = '重度污染';
            levelClass = 'text-danger';
        } else {
            level = '严重污染';
            levelClass = 'text-dark';
        }
        
        return { value: aqiValue, level, levelClass };
    }
    
    // 使用默认的贺州市今日空气质量数据
    function useDefaultHezhouTodayAirQuality() {
        // 默认数据
        const defaultData = {
            pm25: 55,
            pm10: 96,
            o3: 58
        };
        
        // 计算AQI
        const aqi = calculateAqiFromPollutants({
            pm25: defaultData.pm25,
            pm10: defaultData.pm10,
            o3: defaultData.o3,
            no2: 39,
            so2: 16,
            co: 1.2
        });
        
        // 更新指标
        document.getElementById('hezhouPm25').innerHTML = `${defaultData.pm25} <small>μg/m³</small>`;
        document.getElementById('hezhouPm25Level').textContent = '良';
        document.getElementById('hezhouPm25Level').className = 'text-success';
        
        document.getElementById('hezhouPm10').innerHTML = `${defaultData.pm10} <small>μg/m³</small>`;
        document.getElementById('hezhouPm10Level').textContent = '良';
        document.getElementById('hezhouPm10Level').className = 'text-success';
        
        document.getElementById('hezhouO3').innerHTML = `${defaultData.o3} <small>μg/m³</small>`;
        document.getElementById('hezhouO3Level').textContent = '优';
        document.getElementById('hezhouO3Level').className = 'text-success';
        
        document.getElementById('hezhouAqi').textContent = aqi.value;
        document.getElementById('hezhouAqiLevel').textContent = aqi.level;
        document.getElementById('hezhouAqiLevel').className = aqi.levelClass;
    }

    // 排序功能
    document.getElementById('sortAscBtn').addEventListener('click', function() {
        sortTable('asc');
        this.classList.add('active');
        document.getElementById('sortDescBtn').classList.remove('active');
    });

    document.getElementById('sortDescBtn').addEventListener('click', function() {
        sortTable('desc');
        this.classList.add('active');
        document.getElementById('sortAscBtn').classList.remove('active');
    });

    function sortTable(order) {
        const table = document.getElementById('aqiRankingTable');
        table.innerHTML = '';

        if (order === 'asc') {
            // 由低到高排序数据 - 伊犁，齐齐哈尔，青岛，潍坊，呼和浩特
            const ascData = [
                { city: '伊犁', aqi: 35, quality: '优', qualityClass: 'bg-success' },
                { city: '齐齐哈尔', aqi: 42, quality: '优', qualityClass: 'bg-success' },
                { city: '青岛', aqi: 48, quality: '良好', qualityClass: 'bg-success' },
                { city: '潍坊', aqi: 52, quality: '良好', qualityClass: 'bg-success' },
                { city: '呼和浩特', aqi: 58, quality: '良好', qualityClass: 'bg-success' }
            ];
            
            ascData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.city}</td>
                    <td data-aqi="${item.aqi}">${item.aqi}</td>
                    <td><span class="badge ${item.qualityClass}">${item.quality}</span></td>
                `;
                table.appendChild(row);
            });
        } else {
            // 由高到低排序数据 - 延安，安阳，运城，渭南，阜阳
            const descData = [
                { city: '延安', aqi: 156, quality: '中度污染', qualityClass: 'bg-danger' },
                { city: '安阳', aqi: 148, quality: '中度污染', qualityClass: 'bg-danger' },
                { city: '运城', aqi: 142, quality: '轻度污染', qualityClass: 'bg-warning' },
                { city: '渭南', aqi: 138, quality: '轻度污染', qualityClass: 'bg-warning' },
                { city: '阜阳', aqi: 132, quality: '轻度污染', qualityClass: 'bg-warning' }
            ];
            
            descData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.city}</td>
                    <td data-aqi="${item.aqi}">${item.aqi}</td>
                    <td><span class="badge ${item.qualityClass}">${item.quality}</span></td>
                `;
                table.appendChild(row);
            });
        }
    }

    // 导出功能
    document.getElementById('exportCsvBtn').addEventListener('click', function() {
        exportTableToFile('csv');
    });

    document.getElementById('exportExcelBtn').addEventListener('click', function() {
        exportTableToFile('xlsx');
    });

    function exportTableToFile(type) {
        // 使用贺州市污染物表格
        const table = document.getElementById('hezhouPollutantTable');

        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `贺州市污染物数据.${type}`);
    }

    // 实时更新功能
    // 每5分钟自动刷新数据
    setInterval(refreshPage, 5 * 60 * 1000);
});

// 刷新页面获取最新数据
function refreshPage() {
    // 显示加载状态
    showRefreshNotification();
    
    // 延迟1秒后刷新页面，给用户足够的时间看到通知
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// 显示刷新通知
function showRefreshNotification() {
    // 检查是否已存在通知
    let notification = document.getElementById('refreshNotification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'refreshNotification';
        notification.className = 'position-fixed top-0 right-0 m-4 p-3 bg-primary text-white rounded shadow-lg z-50';
        notification.style.transition = 'opacity 0.5s ease';
        document.body.appendChild(notification);
    }
    
    // 更新通知内容并显示
    notification.textContent = '正在更新数据...';
    notification.style.opacity = '1';
    
    // 3秒后隐藏通知
    setTimeout(() => {
        notification.style.opacity = '0';
    }, 3000);
}
</script>
{% endblock %}