{% extends 'pollution_app/base.html' %}

{% block title %}预测结果评估 - 预报预警 - 气象污染预测系统{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- 左侧子项导航（保持不变） -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">预报预警</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'air_pollution_forecast' %}" class="text-decoration-none">大气污染预测</a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'prediction_evaluation' %}" class="text-decoration-none active fw-bold">预测结果评估</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 右侧内容区域 -->
        <div class="col-md-9">
            <div id="prediction-evaluation" class="card">
                <div class="card-header">
                    <h5>预测结果评估</h5>
                </div>
                <div class="card-body">
                    <!-- 总统计图 -->
                    <div class="chart-container mb-4">
                        <canvas id="modelComparisonChart"></canvas>
                    </div>

                    <!-- 新增的模型评估详细图表 -->
                    <div class="chart-container mb-4">
                        <canvas id="pollutantErrorChart"></canvas>
                    </div>

                    <!-- 模型对比表格 -->
                    <div class="table-responsive mt-4">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>模型</th>
                                    <th>城市</th>
                                    <th>Train MAE</th>
                                    <th>Train RMSE</th>
                                    <th>Train R²</th>
                                    <th>Test MAE</th>
                                    <th>Test RMSE</th>
                                    <th>Test R²</th>
                                    <th>Training time</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 表格数据通过后端渲染 -->
                                {% for item in evaluation_data %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ item.model }}</td>
                                    <td>{{ item.city }}</td>
                                    <td>{{ item.train_mae|floatformat:4 }}</td>
                                    <td>{{ item.train_rmse|floatformat:4 }}</td>
                                    <td>{{ item.train_r2|floatformat:4 }}</td>
                                    <td>{{ item.test_mae|floatformat:4 }}</td>
                                    <td>{{ item.test_rmse|floatformat:4 }}</td>
                                    <td>{{ item.test_r2|floatformat:4 }}</td>
                                    <td>{{ item.training_time|floatformat:2 }}s</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center">暂无评估数据</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- 评估指标说明 -->
                    <div class="mt-4">
                        <h6>评估指标说明：</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">MAE（平均绝对误差）：预测值与实际值绝对偏差的平均值，值越低越好</li>
                            <li class="list-group-item">RMSE（均方根误差）：预测值与实际值偏差的平方根，值越低越好</li>
                            <li class="list-group-item">R²（决定系数）：模型解释数据的能力，值越接近1越好</li>
                            <li class="list-group-item">Training time：模型训练所需时间（秒）</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }
    /* 确保表格内容单行显示 */
    .table th, .table td {
        white-space: nowrap;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
<script>
// 页面加载完成后初始化图表
document.addEventListener('DOMContentLoaded', function() {
    initModelComparisonChart();
    initPollutantErrorChart(); // 初始化污染物误差图表
});

// 初始化模型总统计对比图表
function initModelComparisonChart() {
    const ctx = document.getElementById('modelComparisonChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['线性回归', '神经网络', '后端随机森林'],
            datasets: [
                {
                    label: '平均 Test RMSE',
                    data: {{ avg_rmse|safe }},
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                },
                {
                    label: '平均 Test R²',
                    data: {{ avg_r2|safe }},
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'y1',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'RMSE 值'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    beginAtZero: true,
                    max: 1,  // R²最大值为1
                    title: { display: true, text: 'R² 值' },
                    grid: {
                        drawOnChartArea: false  // 不绘制网格线，避免与左侧轴冲突
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '模型性能总统计对比（RMSE & R²）'
                }
            }
        }
    });
}

// 初始化新增的污染物误差对比图表
function initPollutantErrorChart() {
    const ctx = document.getElementById('pollutantErrorChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['PM2.5', 'PM10', 'NO₂', 'SO₂', 'O₃', 'CO'],
            datasets: [
                {
                    label: '线性回归 Test MAE',
                    data: [8.2, 9.5, 6.3, 4.1, 7.8, 0.3],
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                },
                {
                    label: '线性回归 Test RMSE',
                    data: [10.6, 12.1, 8.2, 5.3, 9.7, 0.4],
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                },
                {
                    label: '神经网络 Test MAE',
                    data: [5.1, 6.8, 4.2, 3.0, 5.5, 0.2],
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: '神经网络 Test RMSE',
                    data: [7.3, 8.9, 5.6, 3.9, 7.1, 0.3],
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '误差值'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '各污染物预测误差对比（MAE & RMSE）'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}
</script>
{% endblock %}