{% extends 'pollution_app/base.html' %}

{% block title %}数据操作 - 气象污染预测系统{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- 左侧子项导航（添加数据操作选项） -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">数据管理</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'data_management' %}" class="text-decoration-none">数据上传</a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'history_query' %}" class="text-decoration-none">历史数据查询</a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'data_export' %}" class="text-decoration-none">数据导出</a>
                    </li>
                    <!-- 新增数据操作子项 -->
                    <li class="list-group-item ">
                        <a href="{% url 'data_operation' %}" class="text-decoration-none active fw-bold">数据操作</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 右侧内容区域（增删改查功能） -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h5>数据操作（增删改查）</h5>
                </div>
                <div class="card-body">
                    <!-- 新增/编辑表单 -->
                    <form method="post" action="{% if edit_id %}{% url 'edit_data' edit_id %}{% else %}{% url 'add_data' %}{% endif %}">
                        {% csrf_token %}
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">日期时间</label>
                                {{ form.date }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">PM2.5</label>
                                {{ form.pm25 }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">PM10</label>
                                {{ form.pm10 }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">SO₂</label>
                                {{ form.so2 }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">CO</label>
                                {{ form.co }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">NO₂</label>
                                {{ form.no2 }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">O₃</label>
                                {{ form.o3 }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">温度(°C)</label>
                                {{ form.temperature }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">气压(hPa)</label>
                                {{ form.pressure }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">降水量(mm)</label>
                                {{ form.precipitation }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">相对湿度(%)</label>
                                {{ form.humidity }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">风速(m/s)</label>
                                {{ form.wind_speed }}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            {% if edit_id %}更新数据{% else %}新增数据{% endif %}
                        </button>
                        {% if edit_id %}
                            <a href="{% url 'data_operation' %}" class="btn btn-outline-secondary ms-2">取消编辑</a>
                        {% endif %}
                    </form>

                    <!-- 数据列表（查询/删除） -->
                    <div class="mt-5">
                        <h6>已上传数据列表</h6>
                        <!-- 已上传数据列表标题下方搜索框 -->
                        <div class="mt-3 mb-3">
                            <form method="get" action="{% url 'data_operation' %}" class="d-flex">
                                <input type="text" name="search" class="form-control me-2"
                                       placeholder="搜索日期或污染物数值..."
                                       value="{{ request.GET.search|default:'' }}">
                                <button type="submit" class="btn btn-outline-primary">搜索</button>
                                {% if request.GET.search %}
                                    <a href="{% url 'data_operation' %}" class="btn btn-outline-secondary ms-1">清除</a>
                                {% endif %}
                            </form>
                        </div>

                        <!-- 数据分类标签 -->
                        <ul class="nav nav-tabs mb-3">
                            <li class="nav-item">
                                <a class="nav-link active" id="pollutant-tab" data-bs-toggle="tab" href="#pollutant-data">污染物数据</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="meteorology-tab" data-bs-toggle="tab" href="#meteorology-data">气象数据</a>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <!-- 污染物数据表格 -->
                            <div class="tab-pane fade show active" id="pollutant-data">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>日期时间</th>
                                                <th>PM2.5</th>
                                                <th>PM10</th>
                                                <th>SO₂</th>
                                                <th>CO</th>
                                                <th>NO₂</th>
                                                <th>O₃</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for data in data_list %}
                                            <tr {% if data.is_hidden %}class="table-secondary"{% endif %}>
                                                <td>{{ data.date|date:"Y-m-d H:i" }}</td>
                                                <td>{{ data.pm25 }}</td>
                                                <td>{{ data.pm10 }}</td>
                                                <td>{{ data.so2 }}</td>
                                                <td>{{ data.co }}</td>
                                                <td>{{ data.no2 }}</td>
                                                <td>{{ data.o3 }}</td>
                                                <td>
                                                    {% if data.is_hidden %}
                                                        <span class="badge bg-secondary">已隐藏</span>
                                                    {% else %}
                                                        <span class="badge bg-success">显示中</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{% url 'edit_data' data.id %}" class="btn btn-sm btn-outline-primary">编辑</a>
                                                    <a href="{% url 'delete_data' data.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('确定删除这条数据吗？')">删除</a>
                                                    <!-- 隐藏/查看切换按钮 -->
                                                    <a href="{% url 'toggle_data_visibility' data.id %}" class="btn btn-sm {% if data.is_hidden %}btn-outline-success{% else %}btn-outline-secondary{% endif %}">
                                                        {% if data.is_hidden %}显示{% else %}隐藏{% endif %}
                                                    </a>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr><td colspan="8" class="text-center">暂无污染物数据</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 气象数据表格 -->
                            <div class="tab-pane fade" id="meteorology-data">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>日期时间</th>
                                                <th>温度(°C)</th>
                                                <th>气压(hPa)</th>
                                                <th>降水量(mm)</th>
                                                <th>相对湿度(%)</th>
                                                <th>风速(m/s)</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for data in data_list %}
                                            <tr>
                                                <td>{{ data.date|date:"Y-m-d H:i" }}</td>
                                                <td>{{ data.temperature }}</td>     <!-- 温度字段 -->
                                                <td>{{ data.pressure }}</td>         <!-- 气压字段 -->
                                                <td>{{ data.precipitation }}</td>   <!-- 降水量字段 -->
                                                <td>{{ data.humidity }}</td>        <!-- 湿度字段 -->
                                                <td>{{ data.wind_speed }}</td>      <!-- 风速字段 -->
                                                <td>
                                                    {% if data.is_hidden %}
                                                        <span class="badge bg-secondary">已隐藏</span>
                                                    {% else %}
                                                        <span class="badge bg-success">显示中</span>
                                                    {% endif %}
                                                    <a href="{% url 'edit_data' data.id %}" class="btn btn-sm btn-outline-primary">编辑</a>
                                                    <a href="{% url 'delete_data' data.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('确定删除这条数据吗？')">删除</a>
                                                    <!-- 隐藏/查看切换按钮 -->
                                                    <a href="{% url 'toggle_data_visibility' data.id %}" class="btn btn-sm {% if data.is_hidden %}btn-outline-success{% else %}btn-outline-secondary{% endif %}">
                                                        {% if data.is_hidden %}显示{% else %}隐藏{% endif %}
                                                    </a>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr><td colspan="5" class="text-center">暂无气象数据</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}