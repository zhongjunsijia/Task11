{% extends 'pollution_app/base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>{{ page_title }}</h2>
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">批量预测</h5>
            <p class="card-text">这是批量预测页面，只有拥有批量预测权限的用户才能访问。</p>
            
            <form id="batchPredictionForm">
                <div class="form-group">
                    <label for="modelType">模型类型</label>
                    <select class="form-control" id="modelType">
                        <option value="linear">线性回归</option>
                        <option value="rf">随机森林</option>
                        <option value="mlp">神经网络</option>
                        <option value="backend_rf">后端随机森林</option>
                    </select>
                </div>
                
                <div class="form-group mt-3">
                    <label>预测数据</label>
                    <div id="predictionDataContainer">
                        <div class="row mt-2" id="dataRow0">
                            <div class="col-md-2">
                                <input type="date" class="form-control" name="date" placeholder="日期">
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control" name="temperature" placeholder="温度">
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control" name="humidity" placeholder="湿度">
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control" name="wind_speed" placeholder="风速">
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control" name="pm25" placeholder="PM2.5">
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control" name="pm10" placeholder="PM10">
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control" name="no2" placeholder="NO2">
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control" name="so2" placeholder="SO2">
                            </div>
                            <div class="col-md-1">
                                <input type="number" class="form-control" name="o3" placeholder="O3">
                            </div>
                            <div class="col-md-1">
                                <input type="number" step="0.1" class="form-control" name="co" placeholder="CO">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" id="addRowBtn">添加行</button>
                    <button type="button" class="btn btn-danger" id="removeRowBtn">删除行</button>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">执行预测</button>
                </div>
            </form>
            
            <div class="mt-4" id="resultContainer" style="display: none;">
                <h5>预测结果</h5>
                <div class="table-responsive">
                    <table class="table table-striped" id="resultTable">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>PM2.5</th>
                                <th>PM10</th>
                                <th>NO2</th>
                                <th>SO2</th>
                                <th>O3</th>
                                <th>CO</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        let rowCount = 1;
        
        // 添加行
        $('#addRowBtn').click(function() {
            let newRow = $('#dataRow0').clone();
            newRow.attr('id', 'dataRow' + rowCount);
            newRow.find('input').val('');
            $('#predictionDataContainer').append(newRow);
            rowCount++;
        });
        
        // 删除行
        $('#removeRowBtn').click(function() {
            if (rowCount > 1) {
                $('#dataRow' + (rowCount - 1)).remove();
                rowCount--;
            }
        });
        
        // 表单提交
        $('#batchPredictionForm').submit(function(e) {
            e.preventDefault();
            
            let predictionData = [];
            let modelType = $('#modelType').val();
            
            // 收集数据
            for (let i = 0; i < rowCount; i++) {
                let row = $('#dataRow' + i);
                let date = row.find('input[name="date"]').val();
                let temperature = parseFloat(row.find('input[name="temperature"]').val()) || 0;
                let humidity = parseFloat(row.find('input[name="humidity"]').val()) || 0;
                let wind_speed = parseFloat(row.find('input[name="wind_speed"]').val()) || 0;
                let pm25 = parseFloat(row.find('input[name="pm25"]').val()) || 0;
                let pm10 = parseFloat(row.find('input[name="pm10"]').val()) || 0;
                let no2 = parseFloat(row.find('input[name="no2"]').val()) || 0;
                let so2 = parseFloat(row.find('input[name="so2"]').val()) || 0;
                let o3 = parseFloat(row.find('input[name="o3"]').val()) || 0;
                let co = parseFloat(row.find('input[name="co"]').val()) || 0;
                
                if (date) {
                    predictionData.push({
                        date: date,
                        temperature: temperature,
                        humidity: humidity,
                        wind_speed: wind_speed,
                        pm25: pm25,
                        pm10: pm10,
                        no2: no2,
                        so2: so2,
                        o3: o3,
                        co: co
                    });
                }
            }
            
            if (predictionData.length === 0) {
                alert('请至少填写一行预测数据');
                return;
            }
            
            // 发送请求
            $.ajax({
                url: '/api/batch-predict/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    prediction_data: predictionData,
                    model_type: modelType
                }),
                success: function(response) {
                    if (response.code === 200) {
                        // 显示结果
                        $('#resultBody').empty();
                        response.data.forEach(function(item) {
                            let row = '<tr>' +
                                '<td>' + item.date + '</td>' +
                                '<td>' + item.pm25 + '</td>' +
                                '<td>' + item.pm10 + '</td>' +
                                '<td>' + item.no2 + '</td>' +
                                '<td>' + item.so2 + '</td>' +
                                '<td>' + item.o3 + '</td>' +
                                '<td>' + item.co + '</td>' +
                                '</tr>';
                            $('#resultBody').append(row);
                        });
                        $('#resultContainer').show();
                    } else {
                        alert('预测失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('请求失败，请稍后重试');
                }
            });
        });
    });
</script>
{% endblock %}
