{% extends 'pollution_app/base.html' %}

{% block content %}
<div class="container mt-4 mb-6">
    <div class="row">
        <!-- 左侧导航栏 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">分析工具</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'monitoring_analysis' %}?view=calendar" class="text-decoration-none {% if '/monitoring/' in request.path and 'view=calendar' in request.GET.urlencode %}active fw-bold{% endif %}">
                            污染日历
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'pollution_map' %}" class="text-decoration-none {% if '/pollution-map/' in request.path %}active fw-bold{% endif %}">
                            污染地图
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'sounding' %}" class="text-decoration-none active fw-bold">
                            探空图
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'trend_chart' %}" class="text-decoration-none {% if '/monitoring/trend/' in request.path %}active fw-bold{% endif %}">
                            走势图
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="{% url 'windrose' %}" class="text-decoration-none {% if '/windrose/' in request.path %}active fw-bold{% endif %}">
                            风玫瑰图
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 右侧探空图内容区域 -->
        <div class="col-md-9">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">贺州市气象探空图</h5>
                    <div class="d-flex gap-3">
                        <div class="d-flex align-items-center">
                            <label for="sounding-date" class="me-2 mb-0">日期:</label>
                            <input type="date" id="sounding-date" class="form-control form-control-sm" value="2023-06-16">
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="sounding-time" class="me-2 mb-0">时间:</label>
                            <select id="sounding-time" class="form-select form-select-sm">
                                <option value="00" selected>00时</option>
                                <option value="12">12时</option>
                            </select>
                        </div>
                        <button id="refresh-sounding" class="btn btn-sm btn-primary">
                            <i class="bi bi-refresh me-1"></i>刷新数据
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 温度气压高度图（原有图表） -->
                    <div class="mb-6">
                        <h6>温度/气压随高度变化</h6>
                        <div id="temp-pressure-container" style="height: 500px; width: 100%; position: relative;">
                            <canvas id="temp-pressure-chart"></canvas>
                        </div>
                    </div>

                    <!-- 温度湿度散点图 -->
                    <div class="mb-6">
                        <h6>温度湿度散点分布</h6>
                        <div id="temp-humidity-container" style="height: 400px; width: 100%; position: relative;">
                            <canvas id="temp-humidity-chart"></canvas>
                        </div>
                    </div>

                    <!-- 能见度随高度变化图 -->
                    <div class="mb-6">
                        <h6>能见度随高度变化</h6>
                        <div id="visibility-container" style="height: 400px; width: 100%; position: relative;">
                            <canvas id="visibility-chart"></canvas>
                        </div>
                    </div>

                    <!-- 探空数据说明 -->
                    <div class="mt-4 alert alert-info">
                        <h6><i class="bi bi-info-circle me-1"></i>探空图说明</h6>
                        <p class="mb-0 text-sm">探空图显示了贺州市不同高度的气象要素分布，包括温度、湿度、气压、能见度等信息，有助于分析空气污染扩散条件。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .chart-container canvas {
        width: 100% !important;
    }

    /* 风玫瑰图特殊样式 */
    #wind-rose-chart-container {
        max-width: 600px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

<script>
    // 全局图表实例
    let tempPressureChart = null;
    let tempHumidityChart = null;
    let visibilityChart = null;

    // 探空数据
    const soundingData = {
        height: [100, 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 6000, 7000, 8000, 9000, 10000],
        temperature: [28, 26, 24, 22, 19, 16, 13, 10, 7, 4, 1, -5, -12, -19, -26, -33],
        dewPoint: [22, 20, 18, 15, 12, 9, 6, 3, 0, -3, -6, -12, -18, -24, -30, -36],
        pressure: [1000, 950, 900, 850, 800, 750, 700, 650, 600, 550, 500, 450, 400, 350, 300, 250],
        humidity: [75, 72, 70, 68, 65, 62, 60, 58, 55, 52, 50, 48, 45, 42, 40, 38],
        // 新增数据字段
        visibility: [10, 9.5, 9, 8.5, 8, 7.5, 7, 6.5, 6, 5.5, 5, 4.5, 4, 3.5, 3, 2.5], // 能见度(km)
    };

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 检查Chart.js是否加载
        if (typeof Chart === 'undefined') {
            console.error('Chart.js 未加载成功');
            return;
        }

        // 初始化所有图表
        initTempPressureChart();    // 温度/气压随高度变化图
        initTempHumidityChart();    // 温度湿度散点分布
        initVisibilityChart();      // 能见度随高度变化图


        // 绑定刷新按钮事件
        document.getElementById('refresh-sounding').addEventListener('click', function() {
            const btn = this;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>加载中...';
            btn.disabled = true;

            // 刷新数据
            setTimeout(() => {
                refreshAllCharts();
                btn.innerHTML = '<i class="bi bi-refresh me-1"></i>刷新数据';
                btn.disabled = false;
            }, 800);
        });
    });

    // 初始化温度气压图
    function initTempPressureChart() {
        const ctx = document.getElementById('temp-pressure-chart').getContext('2d');

        // 销毁旧实例
        if (tempPressureChart) {
            tempPressureChart.destroy();
        }

        tempPressureChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: soundingData.height,
                datasets: [
                    {
                        label: '温度 (°C)',
                        data: soundingData.temperature,
                        borderColor: '#ff0000',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y'
                    },
                    {
                        label: '露点温度 (°C)',
                        data: soundingData.dewPoint,
                        borderColor: '#0000ff',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y'
                    },
                    {
                        label: '气压 (hPa)',
                        data: soundingData.pressure,
                        borderColor: '#008000',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '高度 (米)'
                        }
                    },
                    y: {
                        position: 'left',
                        title: {
                            display: true,
                            text: '温度 (°C)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    },
                    y1: {
                        position: 'right',
                        title: {
                            display: true,
                            text: '气压 (hPa)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }


    // 初始化温度湿度散点图
    function initTempHumidityChart() {
        const ctx = document.getElementById('temp-humidity-chart').getContext('2d');

        // 销毁旧实例
        if (tempHumidityChart) {
            tempHumidityChart.destroy();
        }

        // 准备散点图数据
        const scatterData = soundingData.height.map((h, i) => ({
            x: soundingData.temperature[i],
            y: soundingData.humidity[i],
            r: h / 1000 // 点大小与高度相关
        }));

        tempHumidityChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: '温度 vs 湿度 (点大小表示高度)',
                    data: scatterData,
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '温度 (°C)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '湿度 (%)'
                        },
                        min: 0,
                        max: 100,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                return [
                                    `温度: ${soundingData.temperature[index]}°C`,
                                    `湿度: ${soundingData.humidity[index]}%`,
                                    `高度: ${soundingData.height[index]}m`
                                ];
                            }
                        }
                    }
                }
            }
        });
    }

    // 初始化能见度随高度变化图
    function initVisibilityChart() {
        const ctx = document.getElementById('visibility-chart').getContext('2d');

        // 销毁旧实例
        if (visibilityChart) {
            visibilityChart.destroy();
        }

        visibilityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: soundingData.height,
                datasets: [{
                    label: '能见度 (km)',
                    data: soundingData.visibility,
                    borderColor: '#ff9900',
                    backgroundColor: 'rgba(255, 153, 0, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: '高度 (米)' } },
                    y: { title: { display: true, text: '能见度 (km)' }, min: 0 }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                return [
                                    `能见度: ${soundingData.visibility[index]}km`,
                                    `高度: ${soundingData.height[index]}m`
                                ];
                            }
                        }
                    }
                }
            }
        });
    }


    // 刷新所有图表数据
    function refreshAllCharts() {
        // 温度气压图数据
        const newTempData = soundingData.temperature.map(val => val + (Math.random() * 4 - 2));
        const newDewData = soundingData.dewPoint.map(val => val + (Math.random() * 4 - 2));
        const newPressureData = soundingData.pressure.map(val => val + (Math.random() * 20 - 10));

        tempPressureChart.data.datasets[0].data = newTempData;
        tempPressureChart.data.datasets[1].data = newDewData;
        tempPressureChart.data.datasets[2].data = newPressureData;
        tempPressureChart.update();

        // 温度湿度散点图数据
        const newScatterData = soundingData.height.map((h, i) => ({
            x: newTempData[i],
            y: soundingData.humidity[i] + (Math.random() * 10 - 5),
            r: h / 1000
        }));
        tempHumidityChart.data.datasets[0].data = newScatterData;
        tempHumidityChart.update();

        // 能见度数据
        const newVisibilityData = soundingData.visibility.map(val => val + (Math.random() * 2 - 1));
        visibilityChart.data.datasets[0].data = newVisibilityData;
        visibilityChart.update();

    }
</script>
{% endblock %}